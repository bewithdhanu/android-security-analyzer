{% extends "base.html" %}

{% block title %}Compare Reports - Android Security Analyzer{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Selection View -->
    <div id="selection-view" class="space-y-4">
        <!-- Header -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
            <h1 class="text-2xl font-bold text-white mb-2">Compare Security Reports</h1>
            <p class="text-gray-400">Compare security analysis results across multiple Android applications</p>
            
            <!-- Stats Bar -->
            <div class="mt-4 grid grid-cols-3 gap-4">
                <div class="bg-gray-700 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-primary">{{ reports|length }}</div>
                    <div class="text-sm text-gray-400">Total Reports</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-white" id="selected-count">0</div>
                    <div class="text-sm text-gray-400">Selected</div>
                </div>
                <div class="bg-gray-700 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-success">2-10</div>
                    <div class="text-sm text-gray-400">Required Range</div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
            <div class="flex items-center space-x-4 mb-6">
                <div class="flex-1">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-reports" 
                            placeholder="Search by app name, package name, or version..."
                            class="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-primary transition-colors"
                            onkeyup="filterReports()"
                        >
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <button 
                    onclick="compareReports()" 
                    id="compare-btn"
                    disabled
                    class="bg-primary hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-sm font-medium flex items-center space-x-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-code-compare"></i>
                    <span>Compare Selected</span>
                </button>
            </div>

            <!-- Grid View of Reports -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="report-list">
                {% for report in reports %}
                <div class="bg-gray-700 rounded-lg border border-gray-600 hover:border-primary transition-all duration-200 ease-in-out hover:-translate-y-0.5 hover:shadow-lg cursor-pointer report-item group"
                     onclick="toggleReportSelection(this, {{ report.id }})"
                     data-report-id="{{ report.id }}"
                     data-app-name="{{ report.app_name }}"
                     data-package-name="{{ report.package_name }}"
                     data-version="{{ report.version }}"
                     data-scan-time="{{ report.scan_time.strftime('%Y-%m-%d %H:%M') }}"
                     data-critical="{{ report.critical_issues }}"
                     data-high="{{ report.high_issues }}"
                     data-medium="{{ report.medium_issues }}"
                     data-low="{{ report.low_issues }}"
                     data-total="{{ report.total_issues }}">
                    
                    <div class="p-4">
                        <!-- App Info -->
                        <div class="flex items-start space-x-3 mb-3">
                            <div class="w-12 h-12 bg-gray-600 rounded-lg flex-shrink-0 flex items-center justify-center">
                                {% if report.app_logo %}
                                <img src="data:image/png;base64,{{ report.app_logo }}" alt="{{ report.app_name }}" class="w-full h-full rounded-lg">
                                {% else %}
                                <i class="fas fa-mobile-alt text-gray-400 text-xl"></i>
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-white font-medium truncate">{{ report.app_name }}</h3>
                                <p class="text-gray-400 text-sm truncate">{{ report.package_name }}</p>
                                <p class="text-gray-500 text-xs">v{{ report.version }}</p>
                            </div>
                            <div class="selection-indicator w-6 h-6 rounded-full border-2 border-primary flex items-center justify-center group-[.selected]:bg-primary">
                                <i class="fas fa-check text-primary hidden group-[.selected]:block group-[.selected]:text-white"></i>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="bg-gray-800 rounded p-2 text-center">
                                <div class="text-sm text-gray-400">Issues</div>
                                <div class="text-white font-medium">{{ report.total_issues }}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-2 text-center">
                                <div class="text-sm text-gray-400">Critical</div>
                                <div class="text-critical font-medium">{{ report.critical_issues }}</div>
                            </div>
                        </div>

                        <!-- Severity Bar -->
                        <div class="h-1 rounded-full bg-gray-800 overflow-hidden">
                            {% set total = report.total_issues %}
                            {% if total > 0 %}
                                {% if report.critical_issues > 0 %}
                                <div class="h-full bg-critical" style="width: {{ (report.critical_issues/total*100)|round }}%; float: left;"></div>
                                {% endif %}
                                {% if report.high_issues > 0 %}
                                <div class="h-full bg-high" style="width: {{ (report.high_issues/total*100)|round }}%; float: left;"></div>
                                {% endif %}
                                {% if report.medium_issues > 0 %}
                                <div class="h-full bg-medium" style="width: {{ (report.medium_issues/total*100)|round }}%; float: left;"></div>
                                {% endif %}
                                {% if report.low_issues > 0 %}
                                <div class="h-full bg-low" style="width: {{ (report.low_issues/total*100)|round }}%; float: left;"></div>
                                {% endif %}
                            {% endif %}
                        </div>

                        <!-- Scan Time -->
                        <div class="mt-3 text-xs text-gray-500 flex items-center">
                            <i class="fas fa-clock mr-1"></i>
                            {{ report.scan_time.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Comparison Results View -->
    <div id="comparison-results" class="hidden space-y-4">
        <!-- Action Bar -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 flex items-center justify-between">
            <button onclick="backToSelection()" class="btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i>Back to Selection
            </button>
            <button onclick="refreshComparison()" class="btn-primary">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Comparison
            </button>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-2 flex items-center space-x-2">
                    <i class="fas fa-shield-alt text-primary"></i>
                    <span>Security Score</span>
                </h3>
                <div id="security-scores" class="space-y-2"></div>
            </div>

            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-2 flex items-center space-x-2">
                    <i class="fas fa-bug text-primary"></i>
                    <span>Issue Distribution</span>
                </h3>
                <div id="issue-distribution" class="space-y-2"></div>
            </div>

            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-2 flex items-center space-x-2">
                    <i class="fas fa-cubes text-primary"></i>
                    <span>Dependencies</span>
                </h3>
                <div id="dependency-stats" class="space-y-2"></div>
            </div>

            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-2 flex items-center space-x-2">
                    <i class="fas fa-key text-primary"></i>
                    <span>Permissions</span>
                </h3>
                <div id="permission-stats" class="space-y-2"></div>
            </div>
        </div>

        <!-- Detailed Comparison Sections -->
        <div class="space-y-6" id="detailed-comparison">
            <!-- Application Overview -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-info-circle text-primary"></i>
                    <span>Application Overview</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="app-overview">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Security Score Analysis -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-shield-alt text-primary"></i>
                    <span>Security Score Analysis</span>
                </h3>
                <div class="space-y-4" id="security-analysis">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Dependency Analysis -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-cubes text-primary"></i>
                    <span>Dependency Analysis</span>
                </h3>
                <div class="space-y-4" id="dependency-analysis">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Permission Analysis -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-key text-primary"></i>
                    <span>Permission Analysis</span>
                </h3>
                <div class="space-y-4" id="permission-analysis">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Manifest Analysis -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-file-alt text-primary"></i>
                    <span>Manifest Analysis</span>
                </h3>
                <div class="space-y-4" id="manifest-analysis">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Code Analysis -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-code text-primary"></i>
                    <span>Code Analysis</span>
                </h3>
                <div class="space-y-4" id="code-analysis">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Gradle Analysis -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-medium text-white mb-4 flex items-center space-x-2">
                    <i class="fas fa-cogs text-primary"></i>
                    <span>Gradle Analysis</span>
                </h3>
                <div class="space-y-4" id="gradle-analysis">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let selectedReports = new Set();

document.addEventListener('DOMContentLoaded', async function() {
    // Get selected report IDs from URL
    const urlParams = new URLSearchParams(window.location.search);
    const reportIds = urlParams.get('reports');
    
    if (reportIds) {
        // Parse report IDs and mark them as selected
        const ids = reportIds.split(',').map(Number);
        ids.forEach(id => {
            const reportElement = document.querySelector(`.report-item[data-report-id="${id}"]`);
            if (reportElement) {
                selectedReports.add(id);
                reportElement.classList.add('selected');
                reportElement.querySelector('.selection-indicator i').classList.remove('hidden');
            }
        });
        
        updateSelectionCount();
        
        // If we have selected reports, load the comparison
        if (selectedReports.size >= 2) {
            await compareReports(true); // true means don't update URL
        }
    }
});

function toggleReportSelection(element, reportId) {
    if (selectedReports.has(reportId)) {
        selectedReports.delete(reportId);
        element.classList.remove('selected');
        element.querySelector('.selection-indicator i').classList.add('hidden');
    } else {
        if (selectedReports.size >= 10) {
            AppUtils.showFlash('error', 'Maximum 10 reports can be compared at once');
            return;
        }
        selectedReports.add(reportId);
        element.classList.add('selected');
        element.querySelector('.selection-indicator i').classList.remove('hidden');
    }
    
    updateSelectionCount();
}

function updateSelectionCount() {
    const count = selectedReports.size;
    document.getElementById('selected-count').textContent = count;
    
    const compareBtn = document.getElementById('compare-btn');
    compareBtn.disabled = count < 2;
}

function filterReports() {
    const searchTerm = document.getElementById('search-reports').value.toLowerCase();
    const reports = document.querySelectorAll('.report-item');
    
    reports.forEach(report => {
        const appName = report.getAttribute('data-app-name').toLowerCase();
        const packageName = report.getAttribute('data-package-name').toLowerCase();
        const version = report.getAttribute('data-version').toLowerCase();
        
        if (appName.includes(searchTerm) || packageName.includes(searchTerm) || version.includes(searchTerm)) {
            report.style.display = '';
        } else {
            report.style.display = 'none';
        }
    });
}

async function compareReports(skipUrlUpdate = false) {
    if (selectedReports.size < 2) {
        AppUtils.showFlash('error', 'Select at least 2 reports to compare');
        return;
    }
    
    AppUtils.showLoading();
    
    try {
        const reportIds = Array.from(selectedReports);
        
        // Update URL with selected reports (unless skipUrlUpdate is true)
        if (!skipUrlUpdate) {
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('reports', reportIds.join(','));
            window.history.pushState({}, '', newUrl);
        }
        
        const reports = [];
        
        // Fetch full report data for each selected report
        for (const id of reportIds) {
            const response = await fetch(`/api/reports/${id}`);
            if (!response.ok) throw new Error(`Failed to fetch report ${id}`);
            const report = await response.json();
            reports.push(report);
        }
        
        displayComparison(reports);
        document.getElementById('comparison-results').classList.remove('hidden');
        
        // Hide the selection section when showing results
        document.querySelector('#selection-view').classList.add('hidden');
        
        // Add a "Back to Selection" button if it doesn't exist
        let backButton = document.querySelector('#back-to-selection');
        if (!backButton) {
            backButton = document.createElement('button');
            backButton.id = 'back-to-selection';
            backButton.className = 'btn btn-secondary mb-4';
            backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Selection';
            backButton.onclick = backToSelection;
            document.getElementById('comparison-results').insertAdjacentElement('beforebegin', backButton);
        }
        
        // Scroll to results
        document.getElementById('comparison-results').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        AppUtils.showFlash('error', 'Failed to load comparison: ' + error.message);
    } finally {
        AppUtils.hideLoading();
    }
}

function displayComparison(reports) {
    // Display summary cards (existing code)
    displaySecurityScores(reports);
    displayIssueDistribution(reports);
    displayDependencyStats(reports);
    displayPermissionStats(reports);
    
    // Display detailed sections
    displayAppOverview(reports);
    displaySecurityAnalysis(reports);
    displayDependencyAnalysis(reports);
    displayPermissionAnalysis(reports);
    displayManifestAnalysis(reports);
    displayCodeAnalysis(reports);
    displayGradleAnalysis(reports);
}

function displaySecurityScores(reports) {
    const scoresDiv = document.getElementById('security-scores');
    scoresDiv.innerHTML = reports.map(report => {
        const totalIssues = report.metadata?.total_issues || 0;
        const criticalWeight = 10;
        const highWeight = 5;
        const mediumWeight = 2;
        const lowWeight = 1;
        
        const weightedScore = 100 - (
            ((report.summary?.by_severity?.critical || 0) * criticalWeight +
             (report.summary?.by_severity?.high || 0) * highWeight +
             (report.summary?.by_severity?.medium || 0) * mediumWeight +
             (report.summary?.by_severity?.low || 0) * lowWeight) / (totalIssues || 1) * 10
        );
        
        const score = Math.max(0, Math.min(100, weightedScore)).toFixed(1);
        const scoreClass = score >= 90 ? 'text-success' : score >= 70 ? 'text-warning' : 'text-error';
        
        return `
            <div class="flex items-center justify-between">
                <span class="text-gray-400">${report.app_metadata?.app_name || 'Unknown App'}</span>
                <span class="${scoreClass} font-medium">${score}%</span>
            </div>
        `;
    }).join('');
}

function displayIssueDistribution(reports) {
    const distributionDiv = document.getElementById('issue-distribution');
    distributionDiv.innerHTML = reports.map(report => {
        const total = report.metadata?.total_issues || 0;
        const summary = report.summary?.by_severity || { critical: 0, high: 0, medium: 0, low: 0 };
        return `
            <div class="space-y-1">
                <div class="text-gray-400 text-sm">${report.app_metadata?.app_name || 'Unknown App'}</div>
                <div class="flex h-2 rounded-full overflow-hidden">
                    ${summary.critical > 0 ? `
                        <div class="bg-critical" style="width: ${(summary.critical/total*100)}%"></div>
                    ` : ''}
                    ${summary.high > 0 ? `
                        <div class="bg-high" style="width: ${(summary.high/total*100)}%"></div>
                    ` : ''}
                    ${summary.medium > 0 ? `
                        <div class="bg-medium" style="width: ${(summary.medium/total*100)}%"></div>
                    ` : ''}
                    ${summary.low > 0 ? `
                        <div class="bg-low" style="width: ${(summary.low/total*100)}%"></div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function displayDependencyStats(reports) {
    const statsDiv = document.getElementById('dependency-stats');
    statsDiv.innerHTML = reports.map(report => {
        const deps = report.dependencies || { total_count: 0, details: [] };
        return `
            <div class="space-y-1">
                <div class="text-gray-400 text-sm">${report.app_metadata?.app_name || 'Unknown App'}</div>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">Total</span>
                    <span class="text-white">${deps.total_count}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">Outdated</span>
                    <span class="text-warning">${deps.details.filter(d => d.is_outdated).length}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">Vulnerable</span>
                    <span class="text-error">${deps.details.filter(d => d.vulnerabilities && d.vulnerabilities.length).length}</span>
                </div>
            </div>
        `;
    }).join('');
}

function displayPermissionStats(reports) {
    const statsDiv = document.getElementById('permission-stats');
    statsDiv.innerHTML = reports.map(report => {
        const permissions = report.app_metadata?.permissions || [];
        const dangerousPerms = permissions.filter(p => isDangerousPermission(p));
        return `
            <div class="space-y-1">
                <div class="text-gray-400 text-sm">${report.app_metadata?.app_name || 'Unknown App'}</div>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">Total</span>
                    <span class="text-white">${permissions.length}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">Dangerous</span>
                    <span class="text-error">${dangerousPerms.length}</span>
                </div>
            </div>
        `;
    }).join('');
}

function isDangerousPermission(permission) {
    const dangerousPerms = [
        'CAMERA', 'RECORD_AUDIO', 'ACCESS_FINE_LOCATION', 'ACCESS_COARSE_LOCATION',
        'READ_CONTACTS', 'WRITE_CONTACTS', 'READ_CALENDAR', 'WRITE_CALENDAR',
        'READ_EXTERNAL_STORAGE', 'WRITE_EXTERNAL_STORAGE', 'READ_PHONE_STATE'
    ];
    return dangerousPerms.includes(permission);
}

// Replace buildComparisonTable with new detailed view functions
function displayComparison(reports) {
    // Display summary cards (existing code)
    displaySecurityScores(reports);
    displayIssueDistribution(reports);
    displayDependencyStats(reports);
    displayPermissionStats(reports);
    
    // Display detailed sections
    displayAppOverview(reports);
    displaySecurityAnalysis(reports);
    displayDependencyAnalysis(reports);
    displayPermissionAnalysis(reports);
    displayManifestAnalysis(reports);
    displayCodeAnalysis(reports);
    displayGradleAnalysis(reports);
}

function displayAppOverview(reports) {
    const container = document.getElementById('app-overview');
    container.innerHTML = reports.map(report => `
        <div class="bg-gray-700 rounded p-4">
            <div class="text-lg font-medium text-white mb-2">${report.app_metadata?.app_name || 'Unknown App'}</div>
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="text-gray-400">Package:</span>
                    <span class="text-white">${report.app_metadata?.package_name || 'N/A'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Version:</span>
                    <span class="text-white">${report.app_metadata?.version_name || 'N/A'} (${report.app_metadata?.version_code || 'N/A'})</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Target SDK:</span>
                    <span class="text-white">${report.app_metadata?.target_sdk || 'N/A'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Min SDK:</span>
                    <span class="text-white">${report.app_metadata?.min_sdk || 'N/A'}</span>
                </div>
            </div>
        </div>
    `).join('');
}

function displaySecurityAnalysis(reports) {
    const container = document.getElementById('security-analysis');
    container.innerHTML = reports.map(report => {
        const score = calculateSecurityScore(report);
        const scoreClass = score >= 90 ? 'text-success' : score >= 70 ? 'text-warning' : 'text-error';
        
        return `
        <div class="bg-gray-700 rounded p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="text-lg font-medium text-white">${report.app_metadata?.app_name || 'Unknown App'}</div>
                <div class="${scoreClass} text-xl font-bold">${score}%</div>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 rounded p-3">
                        <div class="text-error font-medium mb-1">Critical Issues</div>
                        <div class="text-2xl">${report.summary?.by_severity?.critical || 0}</div>
                    </div>
                    <div class="bg-gray-800 rounded p-3">
                        <div class="text-high font-medium mb-1">High Issues</div>
                        <div class="text-2xl">${report.summary?.by_severity?.high || 0}</div>
                    </div>
                    <div class="bg-gray-800 rounded p-3">
                        <div class="text-medium font-medium mb-1">Medium Issues</div>
                        <div class="text-2xl">${report.summary?.by_severity?.medium || 0}</div>
                    </div>
                    <div class="bg-gray-800 rounded p-3">
                        <div class="text-low font-medium mb-1">Low Issues</div>
                        <div class="text-2xl">${report.summary?.by_severity?.low || 0}</div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function displayDependencyAnalysis(reports) {
    const container = document.getElementById('dependency-analysis');
    container.innerHTML = reports.map(report => {
        const deps = report.dependencies || { total_count: 0, details: [] };
        const outdated = deps.details.filter(d => d.is_outdated);
        const vulnerable = deps.details.filter(d => d.vulnerabilities && d.vulnerabilities.length);
        
        return `
        <div class="bg-gray-700 rounded p-4">
            <div class="text-lg font-medium text-white mb-4">${report.app_metadata?.app_name || 'Unknown App'}</div>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-800 rounded p-3 text-center">
                    <div class="text-gray-400 text-sm">Total</div>
                    <div class="text-2xl text-white">${deps.total_count}</div>
                </div>
                <div class="bg-gray-800 rounded p-3 text-center">
                    <div class="text-gray-400 text-sm">Outdated</div>
                    <div class="text-2xl text-warning">${outdated.length}</div>
                </div>
                <div class="bg-gray-800 rounded p-3 text-center">
                    <div class="text-gray-400 text-sm">Vulnerable</div>
                    <div class="text-2xl text-error">${vulnerable.length}</div>
                </div>
            </div>
            
            ${outdated.length > 0 ? `
            <div class="mb-4">
                <div class="text-warning font-medium mb-2">Outdated Dependencies</div>
                <div class="space-y-2">
                    ${outdated.map(d => `
                    <div class="bg-gray-800 rounded p-2 text-sm">
                        <div class="font-medium">${d.group_id}:${d.artifact_id}</div>
                        <div class="text-gray-400">Current: ${d.version}</div>
                        <div class="text-warning">Latest: ${d.latest_version}</div>
                    </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${vulnerable.length > 0 ? `
            <div>
                <div class="text-error font-medium mb-2">Vulnerable Dependencies</div>
                <div class="space-y-2">
                    ${vulnerable.map(d => `
                    <div class="bg-gray-800 rounded p-2 text-sm">
                        <div class="font-medium">${d.group_id}:${d.artifact_id}</div>
                        <div class="text-gray-400">Version: ${d.version}</div>
                        <div class="text-error">CVEs: ${d.vulnerabilities.map(v => v.id).join(', ')}</div>
                    </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
        `;
    }).join('');
}

function displayPermissionAnalysis(reports) {
    const container = document.getElementById('permission-analysis');
    container.innerHTML = reports.map(report => {
        const permissions = report.app_metadata?.permissions || [];
        const dangerousPerms = permissions.filter(p => isDangerousPermission(p));
        const normalPerms = permissions.filter(p => !isDangerousPermission(p));
        
        return `
        <div class="bg-gray-700 rounded p-4">
            <div class="text-lg font-medium text-white mb-4">${report.app_metadata?.app_name || 'Unknown App'}</div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-800 rounded p-3 text-center">
                    <div class="text-gray-400 text-sm">Total Permissions</div>
                    <div class="text-2xl text-white">${permissions.length}</div>
                </div>
                <div class="bg-gray-800 rounded p-3 text-center">
                    <div class="text-gray-400 text-sm">Dangerous</div>
                    <div class="text-2xl text-error">${dangerousPerms.length}</div>
                </div>
            </div>
            
            ${dangerousPerms.length > 0 ? `
            <div class="mb-4">
                <div class="text-error font-medium mb-2">Dangerous Permissions</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    ${dangerousPerms.map(p => `
                    <div class="bg-gray-800 rounded p-2 text-sm">
                        <i class="fas fa-exclamation-triangle text-error mr-1"></i>
                        ${p}
                    </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${normalPerms.length > 0 ? `
            <div>
                <div class="text-success font-medium mb-2">Normal Permissions</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    ${normalPerms.map(p => `
                    <div class="bg-gray-800 rounded p-2 text-sm">
                        <i class="fas fa-check text-success mr-1"></i>
                        ${p}
                    </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
        `;
    }).join('');
}

function displayManifestAnalysis(reports) {
    const container = document.getElementById('manifest-analysis');
    container.innerHTML = reports.map(report => {
        // Get manifest issues from the correct path in the report data
        const manifestIssues = report.issues?.categorized?.find(cat => 
            cat.category === 'Manifest Analysis' || 
            cat.category === 'Android Manifest'
        )?.issues || [];
        
        return `
        <div class="bg-gray-700 rounded p-4">
            <div class="text-lg font-medium text-white mb-4">${report.app_metadata?.app_name || 'Unknown App'}</div>
            
            <div class="space-y-4">
                ${manifestIssues.length > 0 ? manifestIssues.map(issue => `
                <div class="bg-gray-800 rounded p-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-medium text-${issue.risk_level.toLowerCase()}">
                            ${issue.title}
                        </div>
                        <span class="px-2 py-1 rounded text-xs bg-${issue.risk_level.toLowerCase()} text-white">
                            ${issue.risk_level}
                        </span>
                    </div>
                    <div class="text-gray-400 text-sm mb-2">${issue.description}</div>
                    ${issue.recommendation ? `
                    <div class="text-primary text-sm mt-2 flex items-start">
                        <i class="fas fa-lightbulb mt-1 mr-2"></i>
                        <span>${issue.recommendation}</span>
                    </div>
                    ` : ''}
                </div>
                `).join('') : `
                <div class="text-center py-4">
                    <i class="fas fa-check-circle text-success text-2xl mb-2"></i>
                    <p class="text-gray-400">No manifest issues found</p>
                </div>
                `}
            </div>
        </div>
        `;
    }).join('');
}

function displayCodeAnalysis(reports) {
    const container = document.getElementById('code-analysis');
    container.innerHTML = reports.map(report => {
        // Get code issues from the correct path in the report data
        const codeIssues = report.issues?.categorized?.filter(cat => 
            cat.category === 'Code Analysis' || 
            cat.category === 'Security Keywords' ||
            cat.category === 'Suspicious Domains' ||
            cat.category === 'API Keys and Secrets'
        ).flatMap(cat => cat.issues) || [];
        
        return `
        <div class="bg-gray-700 rounded p-4">
            <div class="text-lg font-medium text-white mb-4">${report.app_metadata?.app_name || 'Unknown App'}</div>
            
            <div class="space-y-4">
                ${codeIssues.length > 0 ? codeIssues.map(issue => `
                <div class="bg-gray-800 rounded p-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-medium text-${issue.risk_level.toLowerCase()}">
                            ${issue.title}
                        </div>
                        <span class="px-2 py-1 rounded text-xs bg-${issue.risk_level.toLowerCase()} text-white">
                            ${issue.risk_level}
                        </span>
                    </div>
                    ${issue.file_path ? `
                    <div class="text-sm text-gray-400 mb-2 flex items-center">
                        <i class="fas fa-file-code mr-2"></i>
                        <span class="font-mono">${issue.file_path}${issue.line_number ? `:${issue.line_number}` : ''}</span>
                    </div>
                    ` : ''}
                    <div class="text-gray-400 text-sm mb-2">${issue.description}</div>
                    ${issue.code_snippet ? `
                    <div class="bg-gray-900 rounded p-2 mb-2 font-mono text-sm overflow-x-auto">
                        <code>${issue.code_snippet}</code>
                    </div>
                    ` : ''}
                    ${issue.recommendation ? `
                    <div class="text-primary text-sm mt-2 flex items-start">
                        <i class="fas fa-lightbulb mt-1 mr-2"></i>
                        <span>${issue.recommendation}</span>
                    </div>
                    ` : ''}
                </div>
                `).join('') : `
                <div class="text-center py-4">
                    <i class="fas fa-check-circle text-success text-2xl mb-2"></i>
                    <p class="text-gray-400">No code issues found</p>
                </div>
                `}
            </div>
        </div>
        `;
    }).join('');
}

function displayGradleAnalysis(reports) {
    const container = document.getElementById('gradle-analysis');
    container.innerHTML = reports.map(report => {
        // Get Gradle issues from the correct path in the report data
        const gradleIssues = report.issues?.categorized?.find(cat => 
            cat.category === 'Gradle Analysis' || 
            cat.category === 'Build Configuration'
        )?.issues || [];
        
        // Get dependency issues
        const dependencyIssues = report.dependencies?.details?.filter(dep => 
            dep.is_outdated || (dep.vulnerabilities && dep.vulnerabilities.length > 0)
        ) || [];
        
        return `
        <div class="bg-gray-700 rounded p-4">
            <div class="text-lg font-medium text-white mb-4">${report.app_metadata?.app_name || 'Unknown App'}</div>
            
            <!-- Configuration Issues -->
            <div class="space-y-4">
                ${gradleIssues.length > 0 ? `
                <div class="mb-6">
                    <h4 class="text-white font-medium mb-3">Configuration Issues</h4>
                    ${gradleIssues.map(issue => `
                    <div class="bg-gray-800 rounded p-3 mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-medium text-${issue.risk_level.toLowerCase()}">
                                ${issue.title}
                            </div>
                            <span class="px-2 py-1 rounded text-xs bg-${issue.risk_level.toLowerCase()} text-white">
                                ${issue.risk_level}
                            </span>
                        </div>
                        <div class="text-gray-400 text-sm mb-2">${issue.description}</div>
                        ${issue.recommendation ? `
                        <div class="text-primary text-sm mt-2 flex items-start">
                            <i class="fas fa-lightbulb mt-1 mr-2"></i>
                            <span>${issue.recommendation}</span>
                        </div>
                        ` : ''}
                    </div>
                    `).join('')}
                </div>
                ` : ''}

                <!-- Dependency Issues -->
                ${dependencyIssues.length > 0 ? `
                <div>
                    <h4 class="text-white font-medium mb-3">Dependency Issues</h4>
                    ${dependencyIssues.map(dep => `
                    <div class="bg-gray-800 rounded p-3 mb-3">
                        <div class="font-medium text-white mb-2">${dep.group_id}:${dep.artifact_id}</div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-400">Current:</span>
                                <span class="text-white">${dep.version}</span>
                            </div>
                            ${dep.latest_version ? `
                            <div>
                                <span class="text-gray-400">Latest:</span>
                                <span class="text-warning">${dep.latest_version}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${dep.vulnerabilities && dep.vulnerabilities.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-error text-sm mb-1">Vulnerabilities:</div>
                            <div class="space-y-1">
                                ${dep.vulnerabilities.map(vuln => `
                                <div class="text-xs">
                                    <span class="text-error">${vuln.id}</span>
                                    ${vuln.description ? `- <span class="text-gray-400">${vuln.description}</span>` : ''}
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    `).join('')}
                </div>
                ` : ''}

                ${gradleIssues.length === 0 && dependencyIssues.length === 0 ? `
                <div class="text-center py-4">
                    <i class="fas fa-check-circle text-success text-2xl mb-2"></i>
                    <p class="text-gray-400">No Gradle or dependency issues found</p>
                </div>
                ` : ''}
            </div>
        </div>
        `;
    }).join('');
}

function calculateSecurityScore(report) {
    const totalIssues = report.metadata?.total_issues || 0;
    if (totalIssues === 0) return 100;
    
    const criticalWeight = 10;
    const highWeight = 5;
    const mediumWeight = 2;
    const lowWeight = 1;
    
    const weightedScore = 100 - (
        ((report.summary?.by_severity?.critical || 0) * criticalWeight +
         (report.summary?.by_severity?.high || 0) * highWeight +
         (report.summary?.by_severity?.medium || 0) * mediumWeight +
         (report.summary?.by_severity?.low || 0) * lowWeight) / (totalIssues || 1) * 10
    );
    
    return Math.max(0, Math.min(100, weightedScore)).toFixed(1);
}

function backToSelection() {
    // Show selection section
    document.querySelector('#selection-view').classList.remove('hidden');
    // Hide results and back button
    document.getElementById('comparison-results').classList.add('hidden');
    document.getElementById('back-to-selection').remove();
    // Clear URL parameters
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.delete('reports');
    window.history.pushState({}, '', newUrl);
}

async function refreshComparison() {
    if (selectedReports.size >= 2) {
        await compareReports(true); // true means don't update URL
        AppUtils.showFlash('success', 'Comparison refreshed successfully');
    }
}
</script>
{% endblock %} 